#!/usr/bin/env bash

set -euo pipefail

# Load plugin library
# shellcheck source=lib/plugin.bash
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/../lib/plugin.bash"

# Main Execution

log_section ":house_with_garden: Setting up environment"

# Set custom checkout path if provided
if [[ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_CHECKOUT_PATH:-}" ]]; then
  BUILDKITE_BUILD_CHECKOUT_PATH="${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_CHECKOUT_PATH}"
  export BUILDKITE_BUILD_CHECKOUT_PATH
  log_info "Using custom checkout path: $BUILDKITE_BUILD_CHECKOUT_PATH"
fi

# Optionally interpolate environment variables in the checkout path
if [[ -n "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_INTERPOLATE_CHECKOUT_PATH:-}" ]]; then
  INTERPOLATED_PATH=$(eval echo "${BUILDKITE_PLUGIN_CUSTOM_CHECKOUT_INTERPOLATE_CHECKOUT_PATH}")
  BUILDKITE_BUILD_CHECKOUT_PATH="$INTERPOLATED_PATH"
  export BUILDKITE_BUILD_CHECKOUT_PATH
  log_info "Using interpolated checkout path: $BUILDKITE_BUILD_CHECKOUT_PATH"
fi
